{% extends 'layout.html' %}
{% block body %}
  <div class="page-header">
    <h1>Chart: {{chart.name }}</h1>
  </div>

  <p>Tags: {{ chart.tagnames|join(', ') }}</p>

  <div id="chart"></div>

  {% if chart.with_table %}
  <table class="table table-striped" id="table"></table>
  {% endif %}

  <script>
  {{ chart.generated_js()|safe }}

  var filtered_points = []
  for (field in data_points) {
    filtered_points.push(gen_field_list(field));
  }

  function gen_field_list(field) {
    var res = [field]
    time_series.forEach(function(ds) {
      if (ds in data_points[field]) {
        res.push(data_points[field][ds]);
      }
      else {
        res.push(null);
      }
    });

    return res;
  }

  if (generate) {
      var chart = c3.generate({
          bindto: '#chart',
          data: {
              x: 'x',
              columns: filtered_points.concat([['x'].concat(time_series)]),
              type: chart_type
          },
          axis: {
              x: {
                  type: 'timeseries',
                  tick: {
                      format: '%Y-%m-%d'
                  }
              }
          },
          line: {
              connect_null: false
          },
          bar: {},
          pie: {
              label: {
                  format: function(value, ratio, id) {
                      return value;
                  }
              }
          },
      });
  }

  {% if chart.with_table %}
      //Generate table header
      var table = document.getElementById('table');
      var header = table.createTHead();
      var headerRow = header.insertRow(0);

      var cell = headerRow.insertCell(-1);
      cell.innerHTML = '<b>Date</b>';
      for (field in data_points) {
          var cell = headerRow.insertCell(-1);
          cell.innerHTML = '<b>' + field + '</b>';
      }

      //Generate table body
      time_series.forEach(function(ds) {
          var row = table.insertRow(-1);
          var cell = row.insertCell(-1);
          cell.innerHTML = ds;
          for (field in data_points) {
              var cell = row.insertCell(-1);
              if (ds in data_points[field]) {
                  cell.innerHTML = data_points[field][ds];
              }
              else {
                  cell.innerHTML = '<small>(No data)</small>';
              }
          }
      });
  {% endif %}
  </script>
{% endblock %}
